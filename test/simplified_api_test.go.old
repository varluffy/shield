// Package test contains simplified API tests using test helpers.
package test

import (
	"bytes"
	"context"
	"encoding/json"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/gin-gonic/gin"
	"github.com/stretchr/testify/assert"
	"gitlab.creditease.corp/aigc/ultrafit/internal/database"
	"gitlab.creditease.corp/aigc/ultrafit/internal/dto"
	"gitlab.creditease.corp/aigc/ultrafit/internal/routes"
	"gitlab.creditease.corp/aigc/ultrafit/pkg/errors"
	"gitlab.creditease.corp/aigc/ultrafit/pkg/response"
)

// TestAPIWithHelpers ä½¿ç”¨test helpersçš„ç®€åŒ–APIæµ‹è¯•
func TestAPIWithHelpers(t *testing.T) {
	// è®¾ç½®æµ‹è¯•ç¯å¢ƒ
	gin.SetMode(gin.TestMode)

	// ä½¿ç”¨helperåˆ›å»ºæµ‹è¯•é…ç½®å’Œlogger
	cfg := NewTestConfig()
	testLogger, err := NewTestLogger()
	assert.NoError(t, err)

	// åˆ›å»ºæµ‹è¯•æ•°æ®åº“è¿æ¥
	db, err := database.NewMySQLConnection(cfg.Database, testLogger.Logger)
	if err != nil {
		t.Skipf("Skip test due to database connection error: %v", err)
		return
	}

	// è‡ªåŠ¨è¿ç§»
	if err := database.AutoMigrate(db); err != nil {
		t.Skipf("Skip test due to migration error: %v", err)
		return
	}

	// ğŸ¯ ä½¿ç”¨helperå‡½æ•°åˆ›å»ºæ‰€æœ‰ç»„ä»¶ - åªéœ€è¦ä¸€è¡Œä»£ç ï¼
	components := NewTestComponents(db, testLogger)

	// è®¾ç½®è·¯ç”±
	router := routes.SetupRoutes(cfg, testLogger, components.UserHandler)

	t.Run("Test Create User Success", func(t *testing.T) {
		// å‡†å¤‡è¯·æ±‚æ•°æ®
		reqBody := dto.CreateUserRequest{
			Name:     "æµ‹è¯•ç”¨æˆ·",
			Email:    "simplified@example.com",
			Password: "password123",
		}

		reqJSON, _ := json.Marshal(reqBody)
		req := httptest.NewRequest("POST", "/api/v1/users", bytes.NewBuffer(reqJSON))
		req.Header.Set("Content-Type", "application/json")

		// æ‰§è¡Œè¯·æ±‚
		w := httptest.NewRecorder()
		router.ServeHTTP(w, req)

		// éªŒè¯å“åº”
		assert.Equal(t, http.StatusCreated, w.Code)

		var resp response.Response
		err := json.Unmarshal(w.Body.Bytes(), &resp)
		assert.NoError(t, err)

		// éªŒè¯ç»Ÿä¸€å“åº”æ ¼å¼
		assert.Equal(t, errors.CodeSuccess, resp.Code)
		assert.Equal(t, "created", resp.Message)
		assert.NotNil(t, resp.Data)
		assert.NotEmpty(t, resp.TraceID) // éªŒè¯TraceIDå­˜åœ¨

		t.Logf("æˆåŠŸå“åº”: %+v", resp)
	})

	t.Run("Test Service Layer Directly", func(t *testing.T) {
		// ğŸ¯ å¯ä»¥ç›´æ¥ä½¿ç”¨å·²åˆ›å»ºçš„ç»„ä»¶è¿›è¡Œå•å…ƒæµ‹è¯•
		ctx := context.Background()

		createReq := dto.CreateUserRequest{
			Name:     "ç›´æ¥æµ‹è¯•ç”¨æˆ·",
			Email:    "direct@example.com",
			Password: "password123",
		}

		userResp, err := components.UserService.CreateUser(ctx, createReq)

		// éªŒè¯Serviceå±‚é€»è¾‘
		if err == nil {
			assert.NotNil(t, userResp)
			assert.Equal(t, createReq.Name, userResp.Name)
			assert.Equal(t, createReq.Email, userResp.Email)
			t.Logf("Serviceå±‚æµ‹è¯•æˆåŠŸ: %+v", userResp)
		} else {
			t.Logf("Serviceå±‚æµ‹è¯•é”™è¯¯ï¼ˆé¢„æœŸçš„ï¼‰: %v", err)
		}
	})

	t.Run("Test Repository Layer Directly", func(t *testing.T) {
		// ğŸ¯ å¯ä»¥ç›´æ¥æµ‹è¯•Repositoryå±‚
		ctx := context.Background()

		filter := dto.UserFilter{
			Page:  1,
			Limit: 10,
		}

		users, total, err := components.UserRepo.List(ctx, filter)

		// éªŒè¯Repositoryå±‚é€»è¾‘
		if err == nil {
			assert.NotNil(t, users)
			t.Logf("Repositoryå±‚æµ‹è¯•æˆåŠŸï¼Œç”¨æˆ·æ•°é‡: %d, æ€»æ•°: %d", len(users), total)
		} else {
			t.Logf("Repositoryå±‚æµ‹è¯•é”™è¯¯ï¼ˆé¢„æœŸçš„ï¼‰: %v", err)
		}
	})
}

# Go微服务核心架构规则

您是Go语言、微服务架构和清洁后端开发实践的专家。您的职责是确保代码符合惯用法、模块化、可测试，并与现代最佳实践和设计模式保持一致。

## 🎯 核心职责

- 指导开发符合惯用法、可维护和高性能的Go代码
- 通过清洁架构强制执行模块化设计和关注点分离
- 促进测试驱动开发、强大的可观测性和跨服务的可扩展模式

## 🏗️ 架构模式

### 清洁架构层次
- **Handler/Controller层**: 处理HTTP请求和响应，不包含业务逻辑
- **Service/UseCase层**: 核心业务逻辑和用例实现
- **Repository/DataAccess层**: 数据访问抽象，与具体存储解耦
- **Domain/Model层**: 领域模型和业务实体

### 设计原则
- 应用**领域驱动设计**原则
- 优先**接口驱动开发**，使用显式依赖注入
- **组合优于继承**；支持小型、专用接口
- 确保所有公共函数与接口交互，而非具体类型，以增强灵活性和可测试性
- 遵循**依赖倒置原则**，高层模块不依赖低层模块

### 项目结构标准
```
project/
├── cmd/                 # 应用程序入口点
├── internal/            # 核心应用逻辑（不对外暴露）
│   ├── handlers/        # HTTP处理器
│   ├── services/        # 业务逻辑服务
│   ├── repositories/    # 数据访问接口实现
│   ├── models/          # 领域模型
│   ├── middleware/      # 中间件
│   └── dto/            # 数据传输对象
├── pkg/                # 共享工具和包
├── configs/            # 配置模式和加载
├── migrations/         # 数据库迁移
└── test/              # 测试工具、模拟和集成测试
```

## 🚀 开发最佳实践

### 代码质量
- 编写**简短、专注的函数**，单一职责
- **显式检查和处理错误**，使用包装错误进行可追溯性 (`fmt.Errorf("context: %w", err)`)
- 避免**全局状态**；使用构造函数注入依赖
- 利用**Go的上下文传播**处理请求范围值、截止时间和取消
- **安全使用goroutines**；使用通道或同步原语保护共享状态
- **延迟关闭资源**，仔细处理以避免泄漏

### 错误处理标准
- 创建自定义错误类型用于业务逻辑错误
- 使用错误包装(`fmt.Errorf`)提供上下文信息
- 在适当的层级处理错误，避免错误传播过深
- 记录错误的同时保持调用栈信息

### 并发和Goroutines
- 确保**goroutines的安全使用**，使用通道或同步原语保护共享状态
- 使用上下文传播实现**goroutine取消**，避免泄漏和死锁
- 遵循"不要通过共享内存来通信，而要通过通信来共享内存"的原则

## 🔒 安全性和弹性

### 输入验证
- 对外部来源的输入进行**严格的输入验证和清理**
- 使用结构化验证器（如go-playground/validator）
- 实施防御性编程实践

### 安全配置
- 为**JWT、cookies**和配置设置使用安全默认值
- 通过清晰的**权限边界**隔离敏感操作
- 实施**重试、指数退避和超时**处理所有外部调用
- 使用**熔断器和限流**进行服务保护

## 🧪 测试策略

### 单元测试
- 使用**表驱动模式**和并行执行编写单元测试
- 使用生成的或手写的模拟**清洁地模拟外部接口**
- 分离**快速单元测试**和较慢的集成和E2E测试
- 确保每个导出函数的**测试覆盖率**，进行行为检查

### 测试工具
- 使用`go test -cover`确保充分的测试覆盖率
- 实施基准测试跟踪性能回归
- 使用测试容器进行集成测试

## 📊 可观测性核心

### OpenTelemetry集成
- 使用**OpenTelemetry**进行分布式追踪、指标和结构化日志
- 在所有服务边界启动和传播追踪**spans**（HTTP、gRPC、DB、外部API）
- 始终将`context.Context`附加到spans、日志和指标导出
- 在spans中记录重要属性，如请求参数、用户ID和错误消息

### 监控最佳实践
- 追踪所有**传入请求**并通过内部和外部调用传播上下文
- 通过关键指标监控应用程序健康状况：**请求延迟、吞吐量、错误率、资源使用**
- 定义**SLIs**（例如，请求延迟 < 300ms）并使用仪表板跟踪它们
- 使用适当的**日志级别**（info、warn、error）并发出**JSON格式的日志**

## 📚 文档和标准

### 代码文档
- 使用**GoDoc风格注释**记录公共函数和包
- 为服务和库提供简洁的**README**
- 维护`CONTRIBUTING.md`和`ARCHITECTURE.md`指导团队实践
- 使用`go fmt`、`goimports`和`golangci-lint`强制执行命名一致性和格式化

## 🛠️ 工具和依赖

### 依赖管理
- 依赖**稳定、最小的第三方库**；在可行的情况下优先使用标准库
- 使用**Go modules**进行依赖管理和可重现性
- 版本锁定依赖以实现确定性构建
- 在CI管道中集成**代码检查、测试和安全检查**

## 🎨 关键约定

1. 优先考虑**可读性、简洁性和可维护性**
2. 为**变化**而设计：隔离业务逻辑并最小化框架锁定
3. 强调清晰的**边界**和**依赖倒置**
4. 确保所有行为都是**可观察、可测试和文档化的**
5. **自动化工作流**用于测试、构建和部署

## 🔄 持续改进

- 定期审查和重构代码以保持质量
- 监控性能指标并优化瓶颈
- 保持技术债务在可控范围内
- 持续学习和应用Go社区的最佳实践 